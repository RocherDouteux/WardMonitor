<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WardMonitor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f5f5f5;
    }
    .navbar {
      background-color: #2c2c2cdd;
      border-bottom: 1px solid #444;
    }
    .nav-tabs .nav-link.active {
      background-color: #2c2c2c;
      color: #fff;
      border-color: #444 #444 #1e1e1e;
    }
    .nav-tabs .nav-link {
      color: #ccc;
    }
    .filter-row {
      display: flex;
      gap: 1rem;
      margin-top: 20px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .filter-row select,
    .filter-row button {
      background-color: #2c2c2c;
      color: #f5f5f5;
      border: 1px solid #444;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .ward-table {
      width: 100%;
    }
    .ward-table th,
    .ward-table td {
      background-color: #2c2c2c;
      color: #f5f5f5;
      border: 1px solid #444;
      padding: 8px;
    }
    .ward-table thead th {
      position: sticky;
      top: 0;
      background-color: #1e1e1e;
      z-index: 2;
      cursor: pointer;
    }
    .no-data-message {
      color: #f5f5f5;
      text-align: center;
      margin-top: 1rem;
      font-style: italic;
    }
    .sort-asc::after {
      content: " \25B2";
    }
    .sort-desc::after {
      content: " \25BC";
    }
    #loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div id="loading-indicator">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg px-3">
    <span class="navbar-brand text-light">üèòÔ∏è WardMonitor</span>
    <div class="ms-auto">
      <button id="export-json" class="btn btn-success">Export JSON</button>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="filter-row">
      <select id="filter-size">
        <option value="">All Sizes</option>
        <option value="S">S</option>
        <option value="M">M</option>
        <option value="L">L</option>
      </select>
      <select id="filter-tenant">
        <option value="">All Tenants</option>
        <option value="FreeCompany">FreeCompany</option>
        <option value="Both">Both</option>
        <option value="Individual">Individual</option>
      </select>
      <select id="filter-availability">
        <option value="">All Availability</option>
        <option value="Yes">Available</option>
        <option value="No">Unavailable</option>
      </select>
      <button onclick="setPreset('availability', 'Yes')">Only Available</button>
      <button onclick="setPreset('size', 'L')">Only Large</button>
      <button onclick="setPreset('tenant', 'FreeCompany')">Free Company Only</button>
    </div>

    <ul class="nav nav-tabs" id="regionTabs" role="tablist">
      {% for region in regions %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-btn-{{ loop.index }}" data-bs-toggle="tab" data-bs-target="#tab-{{ loop.index }}" type="button" role="tab">{{ region.region_name }}</button>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content mt-3">
      {% for region in regions %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab-{{ loop.index }}">
        <div class="table-responsive">
          <table class="table table-dark table-bordered table-sm align-middle ward-table">
            <thead>
              <tr>
                <th>Ward</th>
                <th>Plot</th>
                <th>Size</th>
                <th id="price-header">Price</th>
                <th>Available</th>
                <th>Tenant</th>
              </tr>
            </thead>
            <tbody>
              {% for ward in region.wards %}
              {% for plot in ward.plots %}
              <tr>
                <td>{{ ward.ward_id }}</td>
                <td>{{ plot.plot_number }}</td>
                <td>{{ plot.size }}</td>
                <td data-price="{{ plot.price }}">{{ "{:,}".format(plot.price) }} gil</td>
                <td>
                  {% if plot.available %}
                    <span class="badge bg-success">Available</span>
                  {% else %}
                    <span class="badge bg-secondary">Unavailable</span>
                  {% endif %}
                </td>
                <td>
                  {{ plot.tenant_type }}
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
              <tr class="no-data-message" style="display: none;">
                <td colspan="6" class="text-center fst-italic">No plots match the selected filters.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
    const filterSize = document.getElementById("filter-size");
    const filterTenant = document.getElementById("filter-tenant");
    const filterAvailability = document.getElementById("filter-availability");
    const filters = [filterSize, filterTenant, filterAvailability];
    const loading = document.getElementById("loading-indicator");

    filters.forEach(f => f.addEventListener("change", applyFilters));

    function setPreset(type, value) {
      if (type === "size") filterSize.value = value;
      if (type === "tenant") filterTenant.value = value;
      if (type === "availability") filterAvailability.value = value;
      applyFilters();
    }

    function applyFilters() {
      loading.style.display = "flex";

      setTimeout(() => {
        document.querySelectorAll(".ward-table tbody").forEach((tbody) => {
          const rows = Array.from(tbody.querySelectorAll("tr:not(.no-data-message)"));
          let visibleCount = 0;

          rows.forEach(row => {
            const size = row.cells[2].textContent.trim();
            const price = row.cells[3].textContent.trim();
            const available = row.cells[4].textContent.includes("Available") ? "Yes" : "No";
            const tenant = row.cells[5].textContent.trim();

            const sizeMatch = !filterSize.value || filterSize.value === size;
            const availMatch = !filterAvailability.value || filterAvailability.value === available;
            const tenantMatch = !filterTenant.value || tenant.includes(filterTenant.value);

            const match = sizeMatch && availMatch && tenantMatch;
            row.style.display = match ? "" : "none";

            if (match) visibleCount++;
          });

          const noDataRow = tbody.querySelector(".no-data-message");
          if (noDataRow) {
            noDataRow.style.display = visibleCount === 0 ? "table-row" : "none";
          }
        });

        const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltips.map(el => new bootstrap.Tooltip(el));

        loading.style.display = "none";
      }, 10);
    }

    let priceSortAsc = true;
    document.addEventListener("DOMContentLoaded", () => {
      applyFilters();
      document.querySelectorAll("#price-header").forEach(header => {
        header.addEventListener("click", () => {
          document.querySelectorAll(".ward-table tbody").forEach((tbody) => {
            const rows = Array.from(tbody.querySelectorAll("tr:not(.no-data-message)"));
            rows.sort((a, b) => {
              const aPrice = parseInt(a.cells[3].getAttribute("data-price"));
              const bPrice = parseInt(b.cells[3].getAttribute("data-price"));
              return priceSortAsc ? aPrice - bPrice : bPrice - aPrice;
            });
            rows.forEach(row => tbody.appendChild(row));
          });
          priceSortAsc = !priceSortAsc;
        });
      });
    });

    document.getElementById("export-json").addEventListener("click", () => {
      const regions = [];
      document.querySelectorAll(".tab-pane").forEach((regionPane, idx) => {
        const regionName = document.querySelectorAll(".nav-link")[idx].textContent.trim();
        const rows = regionPane.querySelectorAll("tbody tr");
        const plotsByWard = {};

        rows.forEach((row) => {
          if (row.style.display === "none" || row.classList.contains("no-data-message")) return;
          const cells = row.querySelectorAll("td");
          const wardId = parseInt(cells[0].textContent.trim());
          const plot = {
            plot_number: parseInt(cells[1].textContent.trim()),
            size: cells[2].textContent.trim(),
            price: parseInt(cells[3].getAttribute("data-price")),
            available: cells[4].textContent.includes("Available"),
            tenant_type: cells[5].textContent.trim(),
          };
          if (!plotsByWard[wardId]) plotsByWard[wardId] = [];
          plotsByWard[wardId].push(plot);
        });

        const wardList = Object.entries(plotsByWard).map(([wardId, plots]) => ({
          ward_id: parseInt(wardId),
          plots,
        }));

        regions.push({ region_name: regionName, wards: wardList });
      });

      const blob = new Blob([JSON.stringify(regions, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "wardmonitor_data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
